<!DOCTYPE html>
<html>
<head>
    <!-- Latest stable build of Avia OR site code that bundles Avia -->
    <script src="https://vidtech.cbsinteractive.com/avia-js/2.12.0/player/avia.min.js"></script>

    <!-- Latest stable builds of plugins OR site code that bundles plugins -->
    <script src="https://vidtech.cbsinteractive.com/avia-js/2.12.0/plugins/hls/avia.hls.min.js"></script>
    <script src="https://vidtech.cbsinteractive.com/avia-js/2.12.0/plugins/ui/avia.ui.min.js"></script>
    <script src="https://vidtech.cbsinteractive.com/avia-js/2.12.0/plugins/gam/avia.gam.min.js"></script>
    <style>
        .video-presentation-wrapper {
            width: 853px;
            height: 480px;
        }
    </style>
</head>
<body>
    <div class='video-presentation-wrapper'>
        <div id='videoPresentationContainer'>
            <!-- This is the video presentation container -->
        </div>
    </div>

    <script>
        // Create player, passing a container selector and
        // plugin config via playerOptions
        function createPlayer() {
            return avia.createVideoPlayer({
                container: '#videoPresentationContainer',
                plugins: [
                    avia.hls.plugin(),
                    avia.ui.plugin(),
                    avia.gam.plugin({debug:true})
                ]
            })
        }

        // Provide a resource to the player
        function playResource(player) {
            //const resource = {
            //    location: {
            //        mediaUrl: 'http://qthttp.apple.com.edgesuite.net/1010qwoeiuryfg/sl.m3u8'
            //    }
            //};
            var resource = {
                ad: {
                    ssai: {
                        videoId: 'mgid:arc:episode:mtv.com:0d37e555-1a52-11ed-ad8e-0e40cf2fc285',
                        adParameters: {
                            imafw_csid: "vcbs_bet_ctv_roku_vod",
                            imafw_nw: "520311"
                        }
                    }
                }
            }
            var topazUrl = "https://topaz.uat.viacomcbs.digital/topaz/api/"+resource.ad.ssai.videoId+"/mica.json?clientPlatform=desktop";
            fetch(topazUrl)
                .then((response) => response.json())
                .then((data) => {
                    console.log("Topaz data fetched");
                    console.log(data);
                    resource.ad.ssai.contentSourceId=data.imasdk.cmsid;
                    resource.ad.ssai.videoId=data.imasdk.vid;
                    resource.ad.ssai.adParameters["auth-token"] = data.imasdk.authtoken;
                    player.attachResource(resource)
                    .then(() => {
                        console.log("Resource load success");
                        // resource successfully attached to player
                        // video presentation may be clicked to start play
                    })
                    .catch( e => {
                        // a problem prevented attaching the resource
                        console.log(e);
                    })
                });

              
        }

        createPlayer()
            .then( player => {
                playResource(player);
            })
            .catch( e => {
                // problem with player creation
                console.log(e);
            })
    </script>
</body>
</html>